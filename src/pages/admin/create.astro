---
export const prerender = false;
import { supabase } from "../../lib/supabase";
import Layout from '../../components/layout.astro';

const { data: categoriesData } = await supabase
    .from("categories")
    .select("id, name")
    .order("name", { ascending: true });

const categories = categoriesData ?? [];
---

<Layout title="Crear Noticia" hideNavbar={true}>
  <div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
      <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
        <a href="/dashboard" class="inline-flex items-center gap-2 text-gray-600 hover:text-amber-600 transition-colors group">
          <svg class="w-5 h-5 transform group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Volver al Dashboard
        </a>
        <div class="flex items-center gap-2">
          <img src="/images/Logo.jpeg" alt="Logo" class="w-8 h-8 rounded-full" />
          <span class="font-semibold text-gray-900">As√≠ Va Cartagena</span>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 py-8 animate-fade-in">
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Crear Nueva Noticia</h1>
        <p class="text-gray-500 mt-1">Completa el formulario para publicar una nueva noticia</p>
      </div>

      <form id="createForm" class="space-y-6">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 space-y-6 animate-slide-up">
          <!-- T√≠tulo -->
          <div>
            <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
              T√≠tulo de la noticia
            </label>
            <input
              id="title"
              name="title"
              required
              placeholder="Escribe un t√≠tulo atractivo..."
              class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-all outline-none"
            />
          </div>

          <!-- Slug -->
          <div>
            <label for="slug" class="block text-sm font-medium text-gray-700 mb-2">
              Slug (URL amigable)
            </label>
            <div class="flex items-center">
              <span class="px-4 py-3 bg-gray-100 border border-r-0 border-gray-200 rounded-l-xl text-gray-500 text-sm">
                /noticia/
              </span>
              <input
                id="slug"
                name="slug"
                required
                placeholder="mi-noticia-interesante"
                class="flex-1 px-4 py-3 border border-gray-200 rounded-r-xl focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-all outline-none"
              />
            </div>
            <p class="text-xs text-gray-500 mt-1">Se genera autom√°ticamente del t√≠tulo, pero puedes editarlo</p>
          </div>

          <!-- Categor√≠a -->
          <div>
            <label for="category" class="block text-sm font-medium text-gray-700 mb-2">
              Categor√≠a
            </label>
            <select
              id="category"
              name="category"
              required
              class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-all outline-none appearance-none bg-white"
            >
              <option value="">‚Äî Seleccionar categor√≠a ‚Äî</option>
              {categories.map((cat) => (
                <option value={cat.id}>{cat.name}</option>
              ))}
            </select>
          </div>

          <!-- Imagen -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Imagen de portada
            </label>
            <div class="relative">
              <input
                id="image"
                type="file"
                accept="image/*"
                class="hidden"
              />
              <label 
                for="image" 
                id="image-label"
                class="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-gray-300 rounded-xl cursor-pointer hover:border-amber-500 hover:bg-amber-50/50 transition-all"
              >
                <div id="image-preview" class="hidden w-full h-full">
                  <img id="preview-img" class="w-full h-full object-cover rounded-xl" />
                </div>
                <div id="image-placeholder" class="flex flex-col items-center justify-center py-6">
                  <svg class="w-12 h-12 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <p class="text-sm text-gray-600">Haz clic para subir una imagen</p>
                  <p class="text-xs text-gray-400 mt-1">PNG, JPG hasta 10MB</p>
                </div>
              </label>
            </div>
          </div>

          <!-- Contenido -->
          <div>
            <label for="content" class="block text-sm font-medium text-gray-700 mb-2">
              Contenido de la noticia
            </label>
            <textarea
              id="content"
              rows="12"
              required
              placeholder="Escribe el contenido de tu noticia aqu√≠..."
              class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-all outline-none resize-none"
            ></textarea>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex items-center justify-between bg-white rounded-2xl shadow-sm border border-gray-100 p-4 animate-slide-up" style="animation-delay: 0.1s">
          <div id="status" class="text-sm text-gray-600 flex items-center gap-2">
            <span id="status-text"></span>
          </div>
          <div class="flex items-center gap-3">
            <a 
              href="/dashboard"
              class="px-6 py-3 text-gray-700 hover:bg-gray-100 rounded-xl font-medium transition-all"
            >
              Cancelar
            </a>
            <button
              id="submitBtn"
              type="submit"
              class="px-6 py-3 bg-amber-500 hover:bg-amber-600 text-white rounded-xl font-medium transition-all transform hover:scale-105 shadow-lg shadow-amber-500/25 inline-flex items-center gap-2"
            >
              <svg id="submit-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              <svg id="submit-spinner" class="hidden w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span id="submit-text">Crear Noticia</span>
            </button>
          </div>
        </div>
      </form>
    </main>
  </div>

  <style>
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { 
        opacity: 0; 
        transform: translateY(20px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }

    .animate-fade-in {
      animation: fadeIn 0.5s ease-out;
    }

    .animate-slide-up {
      animation: slideUp 0.5s ease-out both;
    }
  </style>

  <script>
    const form = document.getElementById("createForm") as HTMLFormElement;
    const statusText = document.getElementById("status-text") as HTMLSpanElement;
    const titleInput = document.getElementById("title") as HTMLInputElement;
    const slugInput = document.getElementById("slug") as HTMLInputElement;
    const imageInput = document.getElementById("image") as HTMLInputElement;
    const imagePreview = document.getElementById("image-preview") as HTMLDivElement;
    const imagePlaceholder = document.getElementById("image-placeholder") as HTMLDivElement;
    const previewImg = document.getElementById("preview-img") as HTMLImageElement;
    const submitBtn = document.getElementById("submitBtn") as HTMLButtonElement;
    const submitIcon = document.getElementById("submit-icon") as HTMLElement;
    const submitSpinner = document.getElementById("submit-spinner") as HTMLElement;
    const submitText = document.getElementById("submit-text") as HTMLSpanElement;

    // Auto-generate slug from title
    titleInput?.addEventListener("input", () => {
      const slug = titleInput.value
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9\s-]/g, '')
        .trim()
        .replace(/\s+/g, '-');
      slugInput.value = slug;
    });

    // Image preview
    imageInput?.addEventListener("change", () => {
      const file = imageInput.files?.[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImg.src = e.target?.result as string;
          imagePreview.classList.remove("hidden");
          imagePlaceholder.classList.add("hidden");
        };
        reader.readAsDataURL(file);
      }
    });

    // Form submission
    form?.addEventListener("submit", async (e) => {
      e.preventDefault();

      const imageFile = imageInput?.files?.[0];
      if (!imageFile) {
        statusText.textContent = "‚ö†Ô∏è Selecciona una imagen";
        statusText.className = "text-amber-600";
        return;
      }

      // Show loading state
      submitBtn.disabled = true;
      submitIcon.classList.add("hidden");
      submitSpinner.classList.remove("hidden");
      submitText.textContent = "Subiendo...";
      statusText.textContent = "üì§ Subiendo imagen...";
      statusText.className = "text-blue-600";

      try {
        // Upload image
        const imgForm = new FormData();
        imgForm.append("image", imageFile);

        const uploadRes = await fetch("/api/cloudinary/upload-image", {
          method: "POST",
          body: imgForm
        });

        const uploadData = await uploadRes.json();

        if (!uploadData.url) {
          throw new Error("Error subiendo imagen");
        }

        statusText.textContent = "üíæ Guardando noticia...";
        submitText.textContent = "Guardando...";

        // Create news
        const title = titleInput.value;
        const slug = slugInput.value;
        const category_id = (document.getElementById("category") as HTMLSelectElement)?.value;
        const content = (document.getElementById("content") as HTMLTextAreaElement)?.value;

        const res = await fetch("/api/news/create", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title,
            slug,
            content,
            category_id,
            image_url: uploadData.url,
          })
        });

        const data = await res.json();

        if (data.error) {
          throw new Error(data.error);
        }

        statusText.textContent = "‚úÖ ¬°Noticia creada exitosamente!";
        statusText.className = "text-green-600";
        submitText.textContent = "¬°Creada!";

        setTimeout(() => {
          window.location.href = "/dashboard";
        }, 1500);

      } catch (error) {
        statusText.textContent = `‚ùå ${error instanceof Error ? error.message : 'Error desconocido'}`;
        statusText.className = "text-red-600";
        submitBtn.disabled = false;
        submitIcon.classList.remove("hidden");
        submitSpinner.classList.add("hidden");
        submitText.textContent = "Crear Noticia";
      }
    });
  </script>
</Layout>
